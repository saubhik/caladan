#include <stdio.h>

#include <base/log.h>
#include <base/time.h>
#include <net/udp.h>
#include <runtime/runtime.h>
#include <runtime/udp.h>

#include "../fizzwrapper/codeccapi.h"

#define ITERS 10000000
#define SECRET                                                                 \
	"a55599a3915e2eb4c6df354abb171d81f19223c3722b2a9cfa1352d038cbeebf"
#define PACKET_NUM 1206709
#define HEADER_LEN 4
#define BODY_LEN 1438
#define HEADER_FORM 0
#define PACKET_DATA                                                            \
	"421269b50c03803cb922000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"00000000000000000000000000000000000000000000000000000000000000000000000000" \
	"000000000000000000000000000000000000000000000000000000000000000000000000"
#define ENCRYPTED_PACKET_DATA                                                  \
	"5f2c72d224172333b484ceb104cf3b7cd16bbe401055ba5f449014ce1de70b26f34dee901a" \
	"c0a769dbcb611d6825647d8def8361b377c6b8165d2ddb45e5e412d311e685c1034ba94a7d" \
	"9204bc96573ed595406831b2906f3edb8ad58df01606a2db20a5deb5bfb0c54a7b78be98e7" \
	"2fe859bac2b711bfebe14cd3a870f325fbec634aee433df445931ab6a51c8b8659e2e162d1" \
	"fcb30b471e5d8f245e21b208679ab959fac0f8de1708be036a422f7d545e0a4563ee15261f" \
	"6cca680a9f514c64ff12421b69acc6232ce5ba264ea1a1ef73083ccfeb773bd94e3f20dd88" \
	"a60273cf1e50dc50e3d3a11128c2d4acd9de7235fa16049a0255059d47d19cff5b2e5c7e16" \
	"9000ddf727d04ef5dacc84096fece07bd09ae83c2f3fd52c0a3b9cb23981208d5cc259174f" \
	"08bc7bc8c5d469260f92e0fd5c3194495172183a190425eaf781e0b68398f2c3f79010052a" \
	"a5170f571385b380df8b2d78a1134e3c13cb43063343c252cfa4defb185f37a3e949780fa6" \
	"b7990a8442cafd199fd0ba19b1a35710f4a51642449c7f55b241a830480e5c9faf319dbcd8" \
	"a9c87b574472bfc59d9d2e4f0c0d2afff7c593e51e11a81f41565fc968b5cff293d43cb956" \
	"f0ec37875c6eac501dd612946cb834a54674a278e3277e5a3a11ebc9a6c31af97ea521a3a5" \
	"af33c6f550640764e3c483ee79e8448c793bbecc98797a5fdf4f6bc7283759d0adfc50a5e4" \
	"6596814dcb12306d43c2c04b381a68408d6adf7a96d658f4de1c0e85b2daf2f389b3a107ed" \
	"040beb5791285f5463b11889c4b9e470c30b87b3d4e8d40d51a503af329cd63753baaea03d" \
	"42b4e5a586ce971edea69289e4197c890051c2c92836803e103b49f20c096e1cbd04cb879e" \
	"cfa724bd571a834c44065989f47f33f8b07f7493c53dac0ae1cdaf0c89787835c30a2e1db1" \
	"bfaa8d2c07c3f32d7aa5692a5ac568398dbe4ec4ef889f1f404701d6834049a796f4b34705" \
	"9404a6afb051437b19dad698279913eb4652e970672bd50cc17a56d0cdf54108a3a64e8576" \
	"dc6f89cc6b2e385886513fae043eb74e46e7230ccd2aa71444d9dbbfadec284c4fe3f58bfa" \
	"a66eb4aa4cbafd99ce47dc235f38e2d220e4a827eded5a7c3b2d5d7e41e0c38b04854bdbe2" \
	"c57f48e3a5dfceff42beaf5d3a815772bf8aacdb1d7a81f80660ae6e9e4f4f5f5589a332f7" \
	"de4d6eb195c2483c23ca6c4143f9b5ed7f627a13523c3c3e14fdeaa39663137c109b2f3f07" \
	"52eedc258700a88331f44dfc7fd0352849f58fdfd64519ef969e6677c549f07f03d42f0b8c" \
	"9f121f048e061bc78aeb3c2cc6c098b9e0be01f6777fc9525981b65e963fd94f2e9844e656" \
	"3e73ac15d0b816762a6ac7b97595c36639b0a37706e304674e57d4691b81f41d3ae0430b16" \
	"8d2a56d51fa9d5915176c55ed8de501d33a7dd63377e5a68163ee165ac977fd43b9731a24d" \
	"f70c3ae6e77aa85e7122586ced5b940ed33caae648fac603493b7019b5ae874f9253c0fd93" \
	"d1850401a99aa6c7856b22b4b6aa742b35e8097856902323c1d4d1019f094cc94a4db79927" \
	"ed80018a2c8706f877ac9f090d9036be9856d2cc9ffe50a75cd1392077997db1754d21d436" \
	"97dd55dcf1e5e946e69a478132185fbdf94e3e75c2cda3a38859bae6b9322d34fc1d352e75" \
	"f2780be7883cde13a14adbc238eeccc0d936fd3b1e0b6ff9f709561df2a1227d222378873a" \
	"bc56992d833c04cdb93c9bd07037ffea4b5abd915ec271e7182dec47b22e1737dfffc52dae" \
	"0e4cd9b675bc6bd9e35c4b497d49e7036a6bb85991c0ef4634654a7df97492a80825b48ea9" \
	"0f63af9a10f1b0e4329b3eedceabb9005f71b491a8657e0bf3da092a3904764de68ffb9240" \
	"243fe54cedd254b265ccb899eee19b9a8b18f3a467afd22d59e80fdb4806a127d54425b108" \
	"f590e480dc8839310d2bc65dd23ae9bce9c24dd51800e3d5e6e5dc1b9276609a64aca46f0f" \
	"00d6cbe5e4f4a8b2b5978387d79b82317a52f680edf79ac3d6ea057dca41483852f1b5f291" \
	"d86449df7802a890d7921f0a93f42a"

static void main_handler(void *arg) {
	CiphersC *cips;
	uint8_t *data;
	uint8_t buf[48];
	uint8_t dup_data[1458];
	uint8_t encrypted_data[1458];
	double encryptions_per_second;
	uint64_t start_us;
	int i;

	const char hex_str[] = SECRET;
	char chunk[] = PACKET_DATA;
	char encrypted_chunk[] = ENCRYPTED_PACKET_DATA;
	const char *pos = hex_str;
	const char *chunk_pos = chunk;
	const char *encrypted_chunk_pos = encrypted_chunk;

	struct cipher_meta cm = {.aead_index = 0,
													 .header_cipher_index = 0,
													 .packet_num = PACKET_NUM,
													 .header_len = HEADER_LEN,
													 .body_len = BODY_LEN,
													 .header_form = HEADER_FORM};

	memset(buf, 0, 16);
	for (i = 16; i < 48; ++i) {
		sscanf(pos, "%2hhx", &buf[i]);
		pos += 2;
	}

	for (i = 0; i < 1442; ++i) {
		sscanf(chunk_pos, "%2hhx", &dup_data[i]);
		chunk_pos += 2;
	}

	for (i = 0; i < 1458; ++i) {
		sscanf(encrypted_chunk_pos, "%2hhx", &encrypted_data[i]);
		encrypted_chunk_pos += 2;
	}

	log_info("Starting encryptions");
	cips = CiphersC_create();
	CiphersC_compute_ciphers(cips, (uint8_t *) buf, 48);
	start_us = microtime();
	for (i = 0; i < ITERS; i++) {
		data = malloc(sizeof(*data) * 1458);
		memcpy(data, dup_data, 1442);
		CiphersC_inplace_encrypt(cips, cm.aead_index, cm.packet_num, data,
														 cm.header_len, data + cm.header_len,
														 cm.body_len + CIPHER_OVERHEAD);
		CiphersC_encrypt_packet_header(cips, cm.header_cipher_index, cm.header_form,
																	 data, cm.header_len, data + cm.header_len,
																	 cm.body_len + CIPHER_OVERHEAD);
		free(data);
	}
	encryptions_per_second =
		(double) ITERS / ((microtime() - start_us) * 0.000001);
	log_info("%f encryptions / second", encryptions_per_second);
	CiphersC_destroy(cips);
	if (memcmp(data, encrypted_data, 1458)) {
		for (i = 0; i < 1458; ++i) printf("%02x,", *((uint8_t *) data + i));
		printf("\n");
		for (i = 0; i < 1458; ++i)
			printf("%02x,", *((uint8_t *) encrypted_data + i));
		printf("\n");
		log_info("Incorrect encryption");
	}
	log_info("Correct encryption");
}

int main(int argc, char *argv[]) {
	int ret;

	if (argc < 2) {
		printf("arg must be config file\n");
		return -EINVAL;
	}

	ret = runtime_init(argv[1], main_handler, NULL);
	if (ret) {
		printf("failed to start runtime\n");
		return ret;
	}

	return 0;
}